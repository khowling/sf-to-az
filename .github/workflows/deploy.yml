name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_infra:
        description: 'Force infrastructure deployment'
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

env:
  RESOURCE_GROUP: mycrm-rg
  LOCATION: uksouth
  APP_NAME: mycrm

jobs:
  # Detect what changed to decide if infra needs deploying
  changes:
    runs-on: ubuntu-latest
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            infra:
              - 'infra/**'

  # Only runs when infra/ files changed, on first deploy, or manual trigger
  infra:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.infra == 'true' || github.event.inputs.force_infra == 'true'
    outputs:
      acr_login_server: ${{ steps.deploy.outputs.ACR_LOGIN_SERVER }}
      acr_name: ${{ steps.deploy.outputs.ACR_NAME }}
      app_url: ${{ steps.deploy.outputs.APP_URL }}
      pg_fqdn: ${{ steps.deploy.outputs.PG_FQDN }}
    steps:
      - uses: actions/checkout@v4
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create resource group
        run: az group create --name ${{ env.RESOURCE_GROUP }} --location ${{ env.LOCATION }} --output none

      - name: Deploy infrastructure
        id: deploy
        run: |
          EXISTING_ACR=$(az acr list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].loginServer" -o tsv 2>/dev/null || echo "")
          if [ -n "$EXISTING_ACR" ]; then
            # Use the currently running image so Bicep doesn't try to pull a non-existent tag
            IMAGE=$(az containerapp show --name ${{ env.APP_NAME }}-app --resource-group ${{ env.RESOURCE_GROUP }} \
              --query "properties.template.containers[0].image" -o tsv 2>/dev/null || echo "")
            [ -z "$IMAGE" ] && IMAGE="mcr.microsoft.com/azuredocs/containerapps-helloworld:latest"
          else
            IMAGE="mcr.microsoft.com/azuredocs/containerapps-helloworld:latest"
          fi

          RESULT=$(az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters appName=${{ env.APP_NAME }} containerImage="$IMAGE" dbAdminPassword=${{ secrets.DB_ADMIN_PASSWORD }} \
            --query 'properties.outputs' --output json)

          echo "ACR_LOGIN_SERVER=$(echo $RESULT | jq -r '.acrLoginServer.value')" >> $GITHUB_OUTPUT
          echo "ACR_NAME=$(echo $RESULT | jq -r '.acrName.value')" >> $GITHUB_OUTPUT
          echo "APP_URL=$(echo $RESULT | jq -r '.appUrl.value')" >> $GITHUB_OUTPUT
          echo "PG_FQDN=$(echo $RESULT | jq -r '.pgServerFqdn.value')" >> $GITHUB_OUTPUT

  # Always runs â€” builds image and deploys container
  deploy:
    runs-on: ubuntu-latest
    needs: [changes, infra]
    if: always() && !failure() && !cancelled()
    steps:
      - uses: actions/checkout@v4
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Resolve ACR details â€” from infra job output or by querying Azure
      - name: Get ACR details
        id: acr
        run: |
          ACR_NAME="${{ needs.infra.outputs.acr_name }}"
          ACR_LOGIN_SERVER="${{ needs.infra.outputs.acr_login_server }}"
          PG_FQDN="${{ needs.infra.outputs.pg_fqdn }}"
          APP_URL="${{ needs.infra.outputs.app_url }}"

          if [ -z "$ACR_NAME" ]; then
            ACR_NAME=$(az acr list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
            ACR_LOGIN_SERVER=$(az acr list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].loginServer" -o tsv)
            PG_FQDN=$(az postgres flexible-server list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].fullyQualifiedDomainName" -o tsv)
            APP_URL=$(az containerapp show --name ${{ env.APP_NAME }}-app --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
            APP_URL="https://${APP_URL}"
          fi

          echo "ACR_NAME=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
          echo "PG_FQDN=$PG_FQDN" >> $GITHUB_OUTPUT
          echo "APP_URL=$APP_URL" >> $GITHUB_OUTPUT

      - name: Log in to ACR
        run: az acr login --name ${{ steps.acr.outputs.ACR_NAME }}

      - name: Build and push image
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IMAGE="${{ steps.acr.outputs.ACR_LOGIN_SERVER }}/${{ env.APP_NAME }}"
          docker build -t "${IMAGE}:${SHORT_SHA}" -t "${IMAGE}:sha-${{ github.sha }}" .
          docker push "${IMAGE}:${SHORT_SHA}"
          docker push "${IMAGE}:sha-${{ github.sha }}"
          echo "IMAGE_TAG=${SHORT_SHA}" >> $GITHUB_OUTPUT
        id: build

      - name: Deploy container
        run: |
          IMAGE="${{ steps.acr.outputs.ACR_LOGIN_SERVER }}/${{ env.APP_NAME }}:${{ steps.build.outputs.IMAGE_TAG }}"
          az containerapp update \
            --name ${{ env.APP_NAME }}-app \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image "$IMAGE" \
            --output none

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Run database migrations
        run: |
          cd backend
          npm ci
          npx drizzle-kit push
        env:
          DATABASE_URL: postgres://crmadmin:${{ secrets.DB_ADMIN_PASSWORD }}@${{ steps.acr.outputs.PG_FQDN }}:5432/sf_crm?sslmode=require

      - name: Print app URL
        run: echo "âœ… Deployed to ${{ steps.acr.outputs.APP_URL }}"
      
      - name: Get Azure costs
        id: costs
        continue-on-error: true
        run: |
          # Fetch cost data (may not be available for new deployments)
          START_DATE=$(date -u -d '30 days ago' +%Y-%m-%d 2>/dev/null || date -u -v-30d +%Y-%m-%d)
          END_DATE=$(date -u +%Y-%m-%d)
          
          COST_DATA=$(az costmanagement query \
            --type ActualCost \
            --dataset-aggregation totalCost=Sum \
            --dataset-grouping name=ResourceGroupName type=Dimension \
            --dataset-filter "{\"dimensions\":{\"name\":\"ResourceGroupName\",\"operator\":\"In\",\"values\":[\"${{ env.RESOURCE_GROUP }}\"]}}" \
            --timeframe Custom \
            --time-period from="$START_DATE" to="$END_DATE" \
            --scope "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            --query "properties.rows[0][0]" \
            -o tsv 2>/dev/null || echo "0")
          
          if [ "$COST_DATA" != "0" ] && [ -n "$COST_DATA" ]; then
            echo "COST_30_DAYS=$COST_DATA" >> $GITHUB_OUTPUT
            echo "HAS_COST_DATA=true" >> $GITHUB_OUTPUT
          else
            echo "HAS_COST_DATA=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ Deployment Successful
          
          **Application URL:** ${{ steps.acr.outputs.APP_URL }}
          
          **Version:** \`${{ steps.build.outputs.IMAGE_TAG }}\` (commit: \`${{ github.sha }}\`)
          
          **Resources:**
          - Resource Group: \`${{ env.RESOURCE_GROUP }}\`
          - Location: \`${{ env.LOCATION }}\`
          - Container Registry: \`${{ steps.acr.outputs.ACR_NAME }}\`
          EOF
          
          if [ "${{ steps.costs.outputs.HAS_COST_DATA }}" = "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          
          **ðŸ’° Cost Information:**
          - Last 30 days: \$${{ steps.costs.outputs.COST_30_DAYS }} USD
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          
          **ðŸ’° Estimated Monthly Cost:** ~\$15-25 USD (actual cost data not yet available)
          EOF
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          âš ï¸ **Cold Start Notice:** First request after inactivity may take 10-30 seconds as the container scales from zero.
          EOF
